<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Dashboard - Raju IT</title>
  <link href="css/styles.css" rel="stylesheet" />
  <link href="css/login.css" rel="stylesheet" />
  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    #loadingScreen { 
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 18px;
      background: #f8f9fa;
    }
    #loadingScreen.hidden { display: none !important; }
    
    #mainNav { 
      opacity: 0; 
      transition: opacity 0.3s;
      background-color: #212529 !important;
    }
    #mainNav.show { opacity: 1; }
    
    #mainNav .navbar-nav .nav-item .nav-link {
      color: #fff !important;
    }
    
    #mainNav .navbar-nav .nav-item .nav-link:hover {
      color: #ffc800 !important;
    }
    
    /* Dropdown styling */
    .dropdown-menu {
      background-color: #212529;
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 10rem;
    }
    
    .dropdown-item {
      color: #fff;
      padding: 0.5rem 1rem;
      transition: all 0.3s;
    }
    
    .dropdown-item:hover {
      background-color: #ffc800;
      color: #212529;
    }
    
    .dashboard-content { opacity: 0; transition: opacity 0.3s; }
    .dashboard-content.show { opacity: 1; }
  </style>
</head>
<body id="page-top">

<div id="loadingScreen">
  <p>Loading your dashboard...</p>
</div>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="index.html"><img src="assets/img/navbar-logo.svg" alt="..." /></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars ms-1"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav text-uppercase ms-auto py-4 py-lg-0">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="#products">Products</a></li>
        <li class="nav-item">
          <a class="nav-link" href="#" id="wishlistBtn" title="Wishlist">
            <i class="fas fa-heart"></i>
            <span class="badge bg-danger" id="wishlistCount" style="font-size: 10px; position: relative; top: -5px;">0</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" id="cartBtn" title="Cart">
            <i class="fas fa-shopping-cart"></i>
            <span class="badge bg-primary" id="cartCount" style="font-size: 10px; position: relative; top: -5px;">0</span>
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navUserLink" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="text-transform: none;">
            Hello, <span id="navUserName">User</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navUserLink">
            <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section class="dashboard-content">
  <div class="container" style="margin-top: 100px;">
    <h2>Welcome to Your Dashboard</h2>
    <div class="row">
      <div class="col-md-6">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Account Details</h5>
            <button class="btn btn-sm btn-primary" id="editBtn" onclick="enableEdit()">Edit</button>
          </div>
          
          <div id="viewMode">
            <p><strong>Name:</strong> <span id="name"></span></p>
            <p><strong>Email:</strong> <span id="email"></span></p>
            <p><strong>Phone:</strong> <span id="phone"></span></p>
            <p><strong>Address:</strong> <span id="address"></span></p>
            <p id="lastEditInfo" class="text-muted small mt-3"></p>
          </div>
          
          <form id="editMode" style="display: none;">
            <div class="mb-3">
              <label class="form-label"><strong>Name:</strong></label>
              <input type="text" class="form-control" id="editName" required>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Email:</strong></label>
              <input type="email" class="form-control" id="editEmail" readonly disabled>
              <small class="text-muted">Email cannot be changed</small>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Phone:</strong></label>
              <input type="tel" class="form-control" id="editPhone">
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Address:</strong></label>
              <textarea class="form-control" id="editAddress" rows="3"></textarea>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h5>Quick Links</h5>
          <ul>
            <li><a href="#products">Browse Products</a></li>
            <li><a href="#orders">My Orders</a></li>
            <li><a href="/logout">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Footer-->
<footer class="footer py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-4 text-lg-start">Copyright &copy; Raju It 2025</div>
            <div class="col-lg-4 my-3 my-lg-0">
                <a class="btn btn-dark btn-social mx-2" href="https://www.instagram.com/rajuit1396/?igsh=MWZlOHk4bWxrY3hwMg%3D%3D&fbclid=IwY2xjawOXwtFleHRuA2FlbQIxMABicmlkETFXaXRyMnR5aWF3eHB2SVl4c3J0YwZhcHBfaWQQMjIyMDM5MTc4ODIwMDg5MgABHmKxgCF0yvOPwVkc5ovEt0JNh-K_DZ4egj27cYWVsba8m6bRIbTOszGrRkTA_aem_wyHdzWPSdl7DxeJ2So-lUw&brid=JbRWKsUzQoW71PD4MGNTnw"  aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a class="btn btn-dark btn-social mx-2" href="https://www.facebook.com/profile.php?id=61584622701133" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            </div>
            <div class="col-lg-4 text-lg-end">
                <a class="link-dark text-decoration-none me-3 text-white" href="privacy&policy.html">Privacy Policy</a>
                <a class="link-dark text-decoration-none text-white" href="terms&conditions.html">Terms & Conditions</a>
                <a class="link-dark text-decoration-none text-white" href="return&refund.html">Return & Refund Policy</a>
                <a class="link-dark text-decoration-none text-white" href="shippingpolicy.html">Shipping Policy</a>
                <a class="link-dark text-decoration-none text-white" href="disclaimer.html">Disclaimer</a>
            </div>
        </div>
    </div>
</footer>

<!-- WhatsApp Chat Widget -->
<div class="whatsapp-widget">
    <div class="whatsapp-chat-box" id="whatsappChatBox" style="display: none;">
        <div class="whatsapp-header">
            <img src="https://ui-avatars.com/api/?name=Raju+IT&background=25d366&color=fff" alt="Support" class="whatsapp-avatar">
            <div class="whatsapp-header-text">
                <h4>Raju IT Support</h4>
                <p>Typically replies instantly</p>
            </div>
            <button class="whatsapp-close" onclick="toggleWhatsAppChat()">Ã—</button>
        </div>
        <div class="whatsapp-body">
            <div class="whatsapp-message">
                <p>Hi there! ðŸ‘‹<br>How can we help you?</p>
            </div>
        </div>
        <div class="whatsapp-footer">
            <input type="text" id="whatsappInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendWhatsAppMessage()">
            <button onclick="sendWhatsAppMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    <button class="whatsapp-float" onclick="toggleWhatsAppChat()">
        <i class="fab fa-whatsapp whatsapp-icon"></i>
    </button>
</div>

<!-- âœ… Add Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .whatsapp-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }

    .whatsapp-float {
        width: 60px;
        height: 60px;
        background-color: #25d366;
        color: #FFF;
        border-radius: 50%;
        border: none;
        font-size: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .whatsapp-float:hover {
        background-color: #128c7e;
        transform: scale(1.1);
    }

    .whatsapp-chat-box {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .whatsapp-header {
        background: #075e54;
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .whatsapp-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }

    .whatsapp-header-text h4 {
        margin: 0;
        font-size: 16px;
    }

    .whatsapp-header-text p {
        margin: 0;
        font-size: 12px;
        opacity: 0.8;
    }

    .whatsapp-close {
        margin-left: auto;
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
    }

    .whatsapp-body {
        padding: 20px;
        background: #e5ddd5;
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
    }

    .whatsapp-message {
        background: white;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .whatsapp-message p {
        margin: 0;
        font-size: 14px;
        color: #333;
    }

    .whatsapp-footer {
        background: white;
        padding: 10px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #ddd;
    }

    .whatsapp-footer input {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 15px;
        font-size: 14px;
        outline: none;
    }

    .whatsapp-footer button {
        background: #25d366;
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .whatsapp-footer button:hover {
        background: #128c7e;
    }

    @media screen and (max-width: 767px) {
        .whatsapp-chat-box {
            width: calc(100vw - 40px);
            right: 0;
        }
        
        .whatsapp-float {
            width: 50px;
            height: 50px;
            font-size: 25px;
        }
    }
</style>

<script>
  // WhatsApp Chat Functions
  function toggleWhatsAppChat() {
    const chatBox = document.getElementById('whatsappChatBox');
    if (chatBox.style.display === 'none' || chatBox.style.display === '') {
      chatBox.style.display = 'block';
    } else {
      chatBox.style.display = 'none';
    }
  }

  function sendWhatsAppMessage() {
    const input = document.getElementById('whatsappInput');
    const message = input.value.trim();
    
    if (message) {
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/966539082027?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
      input.value = '';
      
      // Close chat box after sending
      setTimeout(() => {
        document.getElementById('whatsappChatBox').style.display = 'none';
      }, 500);
    }
  }
</script>

<script>
  (async function checkAuth() {
    const token = localStorage.getItem("token");
    const loadingScreen = document.getElementById("loadingScreen");
    const navbar = document.getElementById("mainNav");
    const dashContent = document.querySelector(".dashboard-content");

    console.log("ðŸ” Token stored:", token ? "YES" : "NO");
    if (token) {
      const parts = token.split('.');
      console.log("ðŸ” Token parts:", parts.length, "(should be 3)");
    }

    try {
      const headers = token ? { "Authorization": `Bearer ${token}` } : {};
      console.log("ðŸ” Fetch headers:", headers);
      
      const res = await fetch("/dashboard", { 
        headers, 
        credentials: "include" 
      });

      console.log("ðŸ” Response status:", res.status);
      const data = await res.json().catch(() => null);
      console.log("ðŸ” Response data:", data);

      if (!res.ok) {
        console.error("âŒ Dashboard auth failed:", res.status, data);
        
        // âœ… Try session fallback (stay on page, don't redirect)
        try {
          const sessionRes = await fetch("/check-login", { credentials: "include" });
          const sessionData = await sessionRes.json();
          
          if (sessionData?.loggedIn) {
            console.log("âœ… Session valid, loading dashboard");
            // Session is valid, just hide loading and show content
            loadingScreen.classList.add("hidden");
            setTimeout(() => {
              navbar.classList.add("show");
              dashContent.classList.add("show");
            }, 100);
            
            // Fill with session data
            const u = sessionData.user || {};
            document.getElementById("name").textContent = u.name || "N/A";
            document.getElementById("email").textContent = u.email || "N/A";
            document.getElementById("navUserName").textContent = u.name || u.email || "User";
            return;
          }
        } catch (e) {
          console.error("Session check failed:", e);
        }
        
        // No session and token invalid - redirect home
        localStorage.removeItem("token");
        window.location.href = "/";
        return;
      }

      const u = data?.user || {};

      // âœ… Set user data
      document.getElementById("name").textContent = u.name || "N/A";
      document.getElementById("email").textContent = u.email || "N/A";
      document.getElementById("phone").textContent = u.phone || "N/A";
      document.getElementById("address").textContent = u.address || "N/A";
      document.getElementById("navUserName").textContent = u.name || u.email || "User";
      
      // Set last edit date
      userLastEditDate = u.last_profile_edit || null;
      updateLastEditInfo();

      // âœ… Show content
      loadingScreen.classList.add("hidden");
      setTimeout(() => {
        navbar.classList.add("show");
        dashContent.classList.add("show");
      }, 100);

    } catch (err) {
      console.error("âŒ Auth check failed:", err);
      localStorage.removeItem("token");
      window.location.href = "/";
    }
  })();

  window.addEventListener("pageshow", function(event) {
    if (event.persisted) window.location.reload();
  });

  document.getElementById("logoutBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    localStorage.removeItem("token");
    const res = await fetch("/api/logout", { 
      method: "POST", 
      credentials: "include" 
    });
    window.location.href = "/";
  });

  // Edit Profile Functions
  let userLastEditDate = null;

  function enableEdit() {
    const now = new Date();
    
    // Check if 7 days have passed since last edit
    if (userLastEditDate) {
      const lastEdit = new Date(userLastEditDate);
      const daysSinceEdit = Math.floor((now - lastEdit) / (1000 * 60 * 60 * 24));
      
      if (daysSinceEdit < 7) {
        const daysLeft = 7 - daysSinceEdit;
        alert(`You can edit your profile again in ${daysLeft} day(s). Last edited on ${lastEdit.toLocaleDateString()}`);
        return;
      }
    }
    
    // Populate edit form
    document.getElementById('editName').value = document.getElementById('name').textContent;
    document.getElementById('editEmail').value = document.getElementById('email').textContent;
    document.getElementById('editPhone').value = document.getElementById('phone').textContent || '';
    document.getElementById('editAddress').value = document.getElementById('address').textContent !== 'N/A' ? document.getElementById('address').textContent : '';
    
    // Toggle views
    document.getElementById('viewMode').style.display = 'none';
    document.getElementById('editMode').style.display = 'block';
    document.getElementById('editBtn').style.display = 'none';
  }

  function cancelEdit() {
    document.getElementById('viewMode').style.display = 'block';
    document.getElementById('editMode').style.display = 'none';
    document.getElementById('editBtn').style.display = 'block';
  }

  // Handle edit form submission
  document.getElementById('editMode').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = localStorage.getItem("token");
    const data = {
      name: document.getElementById('editName').value,
      phone: document.getElementById('editPhone').value,
      address: document.getElementById('editAddress').value
    };

    try {
      const res = await fetch('/update-profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        credentials: 'include',
        body: JSON.stringify(data)
      });

      const result = await res.json().catch(() => ({ message: 'Invalid server response' }));
      
      console.log('Update response status:', res.status);
      console.log('Update response data:', result);

      if (res.ok) {
        // Update display
        document.getElementById('name').textContent = data.name;
        document.getElementById('phone').textContent = data.phone || 'N/A';
        document.getElementById('address').textContent = data.address || 'N/A';
        document.getElementById('navUserName').textContent = data.name;
        
        // Update last edit date
        userLastEditDate = result.lastEditDate || new Date().toISOString();
        updateLastEditInfo();
        
        cancelEdit();
        alert('Profile updated successfully!');
      } else {
        console.error('Update failed:', result);
        alert(result.message || 'Failed to update profile. Check console for details.');
      }
    } catch (err) {
      console.error('Update error:', err);
      alert('Error updating profile: ' + err.message);
    }
  });

  function updateLastEditInfo() {
    const lastEditInfoEl = document.getElementById('lastEditInfo');
    if (userLastEditDate) {
      const lastEdit = new Date(userLastEditDate);
      const now = new Date();
      const daysSinceEdit = Math.floor((now - lastEdit) / (1000 * 60 * 60 * 24));
      const daysUntilNext = Math.max(0, 7 - daysSinceEdit);
      
      if (daysUntilNext > 0) {
        lastEditInfoEl.textContent = `Last edited: ${lastEdit.toLocaleDateString()}. You can edit again in ${daysUntilNext} day(s).`;
      } else {
        lastEditInfoEl.textContent = `Last edited: ${lastEdit.toLocaleDateString()}. You can edit your profile now.`;
      }
    }
  }
</script>

</body>
</html>