<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Checkout - Raju IT | Secure Payment & Fast Delivery</title>
    <meta name="description" content="Complete your purchase securely at Raju IT. Multiple payment options, fast delivery across Saudi Arabia. Safe and easy checkout process." />
    <meta name="keywords" content="checkout, payment, secure payment, online payment Saudi Arabia, fast delivery, Raju IT checkout" />
    <meta name="author" content="Raju IT" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="canonical" href="https://rajuit.online/checkout" />
    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/login.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <style>
        /* Navbar styling to match dashboard */
        #mainNav {
            background-color: #212529 !important;
        }
        
        #mainNav .navbar-nav .nav-item .nav-link {
            color: #fff !important;
        }
        
        #mainNav .navbar-nav .nav-item .nav-link:hover {
            color: #ffc800 !important;
        }
        
        /* Checkout Page Styling */
        .checkout-container {
            margin-top: 120px;
            margin-bottom: 60px;
            min-height: 60vh;
        }
        
        .checkout-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .checkout-header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #212529;
            margin-bottom: 10px;
        }
        
        .checkout-header p {
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .checkout-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            padding: 0;
            list-style: none;
        }
        
        .checkout-steps li {
            flex: 1;
            max-width: 200px;
            text-align: center;
            position: relative;
            padding: 20px 10px;
        }
        
        .checkout-steps li:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 35px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }
        
        .checkout-steps li.active .step-number {
            background: #ffc800;
            color: #212529;
        }
        
        .checkout-steps li.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .checkout-steps li.active::after {
            background: #ffc800;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
        }
        
        .step-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .checkout-content {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .checkout-form {
            flex: 1;
            min-width: 300px;
        }
        
        .checkout-summary {
            flex: 0 0 380px;
            min-width: 300px;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .card-header {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            color: #212529;
            border-radius: 12px 12px 0 0 !important;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #ffc800;
            box-shadow: 0 0 0 0.2rem rgba(255, 200, 0, 0.25);
        }
        
        .order-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-item-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }
        
        .order-item-details {
            flex: 1;
        }
        
        .order-item-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 5px;
        }
        
        .order-item-quantity {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .order-item-price {
            font-weight: bold;
            color: #212529;
        }
        
        .order-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .order-summary-row:last-child {
            border-bottom: none;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid #dee2e6;
        }
        
        .order-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: #212529;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .payment-method {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .payment-method:hover {
            border-color: #ffc800;
            background: #fffdf0;
        }
        
        .payment-method.active {
            border-color: #ffc800;
            background: #fffdf0;
        }
        
        .payment-method input[type="radio"] {
            display: none;
        }
        
        .payment-method i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .payment-method label {
            display: block;
            cursor: pointer;
            font-weight: 600;
            color: #212529;
            margin: 0;
        }
        
        .btn-place-order {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            background: #ffc800;
            border: none;
            color: #212529;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .btn-place-order:hover {
            background: #e6b400;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 200, 0, 0.4);
        }
        
        .btn-place-order:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-cart i {
            font-size: 5rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }
        
        .empty-cart h3 {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .security-badges {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .security-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #28a745;
            font-size: 0.9rem;
        }
        
        .security-badge i {
            font-size: 1.2rem;
        }
        
        /* Footer styling to match dashboard */
        .footer {
            background-color: #212529;
            margin-top: 80px;
        }
        
        .footer .text-lg-start,
        .footer .text-lg-end a {
            color: #fff !important;
        }
        
        @media (max-width: 768px) {
            .checkout-header h1 {
                font-size: 2rem;
            }
            
            .checkout-steps {
                flex-direction: column;
                align-items: center;
            }
            
            .checkout-steps li:not(:last-child)::after {
                display: none;
            }
            
            .checkout-content {
                flex-direction: column-reverse;
            }
            
            .checkout-summary {
                flex: 1;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="/"><img src="assets/img/navbar-logo.svg" alt="..." /></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars ms-1"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav text-uppercase ms-auto py-4 py-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/products">Products</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#about">About Us</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#contact">Contact Us</a></li>
                    <li class="nav-item" id="wishlistContainer" style="display: none;">
                        <a class="nav-link" href="#" id="wishlistBtn" title="Wishlist">
                            <i class="fas fa-heart"></i>
                            <span class="badge bg-danger" id="wishlistCount" style="font-size: 10px; position: relative; top: -5px;">0</span>
                        </a>
                    </li>
                    <li class="nav-item" id="cartContainer" style="display: none;">
                        <a class="nav-link" href="#" id="cartBtn" title="Cart">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="badge bg-primary" id="cartCount" style="font-size: 10px; position: relative; top: -5px;">0</span>
                        </a>
                    </li>
                    <li class="nav-item" id="authContainer">
                        <a class="nav-link" href="#" id="navLoginBtn">User</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Checkout Container -->
    <div class="container checkout-container">
        <!-- Checkout Header -->
        <div class="checkout-header">
            <h1>Secure Checkout</h1>
            <p>Complete your order in just a few easy steps</p>
        </div>

        <!-- Progress Steps -->
        <ul class="checkout-steps">
            <li class="active">
                <div class="step-number">1</div>
                <div class="step-label">Shipping</div>
            </li>
            <li>
                <div class="step-number">2</div>
                <div class="step-label">Payment</div>
            </li>
            <li>
                <div class="step-number">3</div>
                <div class="step-label">Confirm</div>
            </li>
        </ul>

        <!-- Empty Cart Message -->
        <div id="emptyCartMessage" class="empty-cart" style="display: none;">
            <i class="fas fa-shopping-cart"></i>
            <h3>Your cart is empty</h3>
            <p class="text-muted mb-4">Add some items to your cart to proceed with checkout</p>
            <a href="products.html" class="btn btn-primary btn-lg">Continue Shopping</a>
        </div>

        <!-- Checkout Content -->
        <div class="checkout-content" id="checkoutContent">
            <!-- Left Column - Forms -->
            <div class="checkout-form">
                <!-- Shipping Information -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-shipping-fast me-2"></i>Shipping Information
                    </div>
                    <div class="card-body">
                        <form id="shippingForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                            <div class="mb-3">
                                <label for="address1" class="form-label">Address Line 1 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="address1" placeholder="Street address, P.O. box" required>
                            </div>
                            <div class="mb-3">
                                <label for="address2" class="form-label">Address Line 2</label>
                                <input type="text" class="form-control" id="address2" placeholder="Apartment, suite, unit, building, floor, etc.">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="upzilla" class="form-label">Upzilla/Thana <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="upzilla" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="city" class="form-label">City/Zilla <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="city" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="state" class="form-label">Division <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="state" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="postalCode" class="form-label">Postal Code <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="postalCode" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="country" class="form-label">Country <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="country" value="Bangladesh" readonly required>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-credit-card me-2"></i>Payment Method
                    </div>
                    <div class="card-body">
                        <div class="payment-methods">
                            <div class="payment-method active" onclick="selectPaymentMethod('cod')">
                                <input type="radio" name="payment" id="cod" value="cod" checked>
                                <label for="cod">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <div>Cash on Delivery</div>
                                </label>
                            </div>
                            <div class="payment-method" onclick="selectPaymentMethod('card')">
                                <input type="radio" name="payment" id="card" value="card">
                                <label for="card">
                                    <i class="fas fa-credit-card"></i>
                                    <div>Credit/Debit Card</div>
                                </label>
                            </div>
                            <div class="payment-method" onclick="selectPaymentMethod('bank')">
                                <input type="radio" name="payment" id="bank" value="bank">
                                <label for="bank">
                                    <i class="fas fa-university"></i>
                                    <div>Bank Transfer</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="security-badges">
                            <div class="security-badge">
                                <i class="fas fa-lock"></i>
                                <span>Secure Payment</span>
                            </div>
                            <div class="security-badge">
                                <i class="fas fa-shield-alt"></i>
                                <span>SSL Protected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="checkout-summary">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-receipt me-2"></i>Order Summary
                    </div>
                    <div class="card-body">
                        <div id="orderItems"></div>
                        
                        <div class="mt-4">
                            <div class="order-summary-row">
                                <span>Subtotal</span>
                                <span id="subtotal">SAR 0.00</span>
                            </div>
                            <div class="order-summary-row">
                                <span>Shipping</span>
                                <span id="shipping">SAR 50.00</span>
                            </div>
                            <div class="order-summary-row">
                                <span>Tax (15%)</span>
                                <span id="tax">SAR 0.00</span>
                            </div>
                            <div class="order-summary-row">
                                <span class="order-total">Total</span>
                                <span class="order-total" id="total">SAR 0.00</span>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-place-order" onclick="placeOrder()">
                            <i class="fas fa-check-circle me-2"></i>Place Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer-->
    <footer class="footer py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 text-lg-start">Copyright &copy; Raju It 2025</div>
                <div class="col-lg-4 my-3 my-lg-0">
                    <a class="btn btn-dark btn-social mx-2" href="https://www.instagram.com/rajuit1396/?igsh=MWZlOHk4bWxrY3hwMg%3D%3D&fbclid=IwY2xjawOXwtFleHRuA2FlbQIxMABicmlkETFXaXRyMnR5aWF3eHB2SVl4c3J0YwZhcHBfaWQQMjIyMDM5MTc4ODIwMDg5MgABHmKxgCF0yvOPwVkc5ovEt0JNh-K_DZ4egj27cYWVsba8m6bRIbTOszGrRkTA_aem_wyHdzWPSdl7DxeJ2So-lUw&brid=JbRWKsUzQoW71PD4MGNTnw" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a class="btn btn-dark btn-social mx-2" href="https://www.facebook.com/profile.php?id=61584622701133" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <a class="link-dark text-decoration-none me-3 text-white" href="privacy&policy.html">Privacy Policy</a>
                    <a class="link-dark text-decoration-none text-white" href="terms&conditions.html">Terms & Conditions</a>
                    <a class="link-dark text-decoration-none text-white" href="return&refund.html">Return & Refund Policy</a>
                    <a class="link-dark text-decoration-none text-white" href="shippingpolicy.html">Shipping Policy</a>
                    <a class="link-dark text-decoration-none text-white" href="disclaimer.html">Disclaimer</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Constants
        const SHIPPING_COST = 50;
        const TAX_RATE = 0.15;
        
        // Load cart items and calculate totals
        function loadCheckout() {
            const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            
            if (cartItems.length === 0) {
                document.getElementById('emptyCartMessage').style.display = 'block';
                document.getElementById('checkoutContent').style.display = 'none';
                return;
            }
            
            // Update badge count
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                cartCount.textContent = cartItems.length;
            }
            
            // Render order items
            const orderItemsContainer = document.getElementById('orderItems');
            orderItemsContainer.innerHTML = cartItems.map(item => `
                <div class="order-item">
                    <img src="/assets/img/products/aaa777.jpg" alt="${item.name}" class="order-item-image">
                    <div class="order-item-details">
                        <div class="order-item-name">${item.name}</div>
                        <div class="order-item-quantity">Qty: ${item.quantity}</div>
                    </div>
                    <div class="order-item-price">SAR ${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');
            
            // Calculate totals
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const total = subtotal + SHIPPING_COST + tax;
            
            // Update summary
            document.getElementById('subtotal').textContent = `SAR ${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = `SAR ${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `SAR ${total.toFixed(2)}`;
        }
        
        // Select payment method
        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            document.getElementById(method).checked = true;
        }
        
        // Place order
        async function placeOrder() {
            const form = document.getElementById('shippingForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            if (cartItems.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login to place an order');
                window.location.href = '/';
                return;
            }
            
            // Get form data
            const shippingData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address1: document.getElementById('address1').value,
                address2: document.getElementById('address2').value,
                upzilla: document.getElementById('upzilla').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postalCode: document.getElementById('postalCode').value,
                country: document.getElementById('country').value
            };
            
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            
            // Calculate totals
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const total = subtotal + SHIPPING_COST + tax;
            
            const shippingAddress = `${shippingData.firstName} ${shippingData.lastName}, ${shippingData.address1}${shippingData.address2 ? ', ' + shippingData.address2 : ''}, ${shippingData.upzilla}, ${shippingData.city}, ${shippingData.state} ${shippingData.postalCode}, ${shippingData.country}. Phone: ${shippingData.phone}`;
            
            // Disable button and show processing message
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            
            // Show processing message
            const processingMessage = document.createElement('div');
            processingMessage.id = 'processingMessage';
            processingMessage.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(33, 37, 41, 0.95); color: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 99999; text-align: center; min-width: 300px;';
            processingMessage.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 15px;">
                    <i class="fas fa-spinner fa-spin" style="color: #ffc800;"></i>
                </div>
                <h3 style="margin: 0 0 10px 0; font-size: 1.5em;">Processing Your Order</h3>
                <p style="margin: 0; font-size: 1.1em; color: #dee2e6;">Please wait a minute while we complete your order...</p>
                <div style="margin-top: 20px; font-size: 0.9em; color: #adb5bd;">
                    <i class="fas fa-info-circle me-2"></i>Do not refresh or close this page
                </div>
            `;
            
            // Add overlay
            const overlay = document.createElement('div');
            overlay.id = 'processingOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99998;';
            
            document.body.appendChild(overlay);
            document.body.appendChild(processingMessage);
            
            try {
                const response = await fetch('/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        items: cartItems,
                        totalAmount: total,
                        shippingAddress: shippingAddress,
                        paymentMethod: paymentMethod
                    })
                });
                
                const result = await response.json();
                
                // Remove processing message and overlay
                const msgElement = document.getElementById('processingMessage');
                const overlayElement = document.getElementById('processingOverlay');
                if (msgElement) msgElement.remove();
                if (overlayElement) overlayElement.remove();
                
                if (response.ok) {
                    // Clear cart
                    localStorage.removeItem('cart');
                    
                    // Store invoice HTML in session storage
                    if (result.invoiceHtml) {
                        sessionStorage.setItem(`invoice_${result.orderId}`, result.invoiceHtml);
                    }
                    
                    // Prepare success message
                    let successMessage = `✅ Order placed successfully!\n\nOrder ID: #${result.orderId}\n`;
                    
                    if (result.emailSent) {
                        successMessage += `Invoice has been sent to your email.\n\n`;
                    } else if (result.emailError) {
                        successMessage += `⚠️ ${result.emailError}\n\n`;
                    } else {
                        successMessage += `Note: Email sending is pending. You can download invoice below.\n\n`;
                    }
                    
                    successMessage += `Click OK to view/download invoice, or Cancel to go to dashboard.`;
                    
                    // Show success message with option to view invoice
                    const viewInvoice = confirm(successMessage);
                    
                    if (viewInvoice) {
                        // Redirect to invoice page
                        window.location.href = `/invoice.html?id=${result.orderId}`;
                    } else {
                        // Redirect to dashboard
                        window.location.href = '/dashboard';
                    }
                } else {
                    alert(result.message || 'Failed to place order. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Place Order';
                }
            } catch (error) {
                console.error('Order error:', error);
                
                // Remove processing message and overlay
                const msgElement = document.getElementById('processingMessage');
                const overlayElement = document.getElementById('processingOverlay');
                if (msgElement) msgElement.remove();
                if (overlayElement) overlayElement.remove();
                
                alert('Error placing order: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Place Order';
            }
        }
        
        // Load user shipping data if available
        async function loadUserShippingData() {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            try {
                const response = await fetch('/get-shipping', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const s = data.shipping || {};
                    
                    if (s.shipping_name) {
                        const nameParts = s.shipping_name.split(' ');
                        document.getElementById('firstName').value = nameParts[0] || '';
                        document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
                    }
                    
                    document.getElementById('phone').value = s.shipping_phone || '';
                    document.getElementById('address1').value = s.shipping_address1 || '';
                    document.getElementById('address2').value = s.shipping_address2 || '';
                    document.getElementById('upzilla').value = s.shipping_upzilla || '';
                    document.getElementById('city').value = s.shipping_city || '';
                    document.getElementById('state').value = s.shipping_state || '';
                    document.getElementById('postalCode').value = s.shipping_postal || '';
                    // Country is always Bangladesh (readonly field)
                }
                
                // Also load user email
                const profileResponse = await fetch('/api/user-data', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include'
                });
                
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    document.getElementById('email').value = profileData.user?.email || '';
                }
            } catch (error) {
                console.error('Error loading shipping data:', error);
            }
        }
        
        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            const authContainer = document.getElementById('authContainer');
            const navLoginBtn = document.getElementById('navLoginBtn');
            const cartContainer = document.getElementById('cartContainer');
            const wishlistContainer = document.getElementById('wishlistContainer');
            
            if (token) {
                try {
                    const response = await fetch('/api/user-data', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const userName = data.user?.name || data.user?.email || 'User';
                        
                        navLoginBtn.textContent = userName;
                        navLoginBtn.href = '/dashboard';
                        
                        // Show cart and wishlist
                        if (cartContainer) cartContainer.style.display = 'block';
                        if (wishlistContainer) wishlistContainer.style.display = 'block';
                        
                        return true;
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                }
            }
            
            // Not authenticated, redirect to home
            alert('Please login to proceed with checkout');
            window.location.href = '/';
            return false;
        }
        
        // Initialize page
        window.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadCheckout();
                loadUserShippingData();
            }
        });
    </script>
</body>
</html>
